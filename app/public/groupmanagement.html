<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Group Management</title>
    <link rel="stylesheet" type="text/css" href="css/navbar.css">
</head>
<body>
    <nav class="navbar">
        <ul class="navbar-menu">
            <li><a href="index.html" class="navbar-item">Search Games</a></li>
            <li><a href="simplesearch.html" class="navbar-item">Search Users/Groups</a></li>
            <li><a href="usermanagement.html" class="navbar-item">Manage Users</a></li>
            <li><a href="groupmanagement.html" class="navbar-item">Manage Groups</a></li>
        </ul>
    </nav>

    <h1>Group Information</h1>

    <!-- JOIN A GROUP -->
    <h2>Join a Group</h2>
    <p>Type a username and pick a group to add this user to that group.</p>

    <label for="joinUsername">Username:</label>
    <input id="joinUsername" type="text" placeholder="Enter your username">
    <br><br>

    <label for="joinGroupSelect">Available Groups:</label>
    <select id="joinGroupSelect">
        <option value="">-- Select a group --</option>
    </select>

    <br><br>
    <button id="joinGroupButton">Join Group</button>
    <div id="joinGroupMessage" class="message"></div>

    <hr>

    <!-- VIEW GROUP MEMBERS -->
    <h2>View Group Members</h2>
    <p>Select a group to see all its members.</p>

    <label for="membersGroupSelect">Group:</label>
    <select id="membersGroupSelect">
        <option value="">-- Select a group --</option>
    </select>

    <br><br>
    <table>
        <thead>
            <tr>
                <th>User ID</th>
                <th>Username</th>
            </tr>
        </thead>
        <tbody id="membersTableBody"></tbody>
    </table>
    <div id="membersMessage" class="message"></div>

    <script>
        // ----- Helper to populate BOTH dropdowns with ALL groups -----
        async function loadAllGroups() {
            try {
                const res = await fetch("/groups");
                const groups = await res.json();

                const joinSelect = document.getElementById("joinGroupSelect");
                const membersSelect = document.getElementById("membersGroupSelect");

                // Clear existing options (except first placeholder)
                joinSelect.length = 1;
                membersSelect.length = 1;

                for (const g of groups) {
                    const opt1 = document.createElement("option");
                    opt1.value = g.groupid;
                    opt1.textContent = g.group_name;
                    joinSelect.appendChild(opt1);

                    const opt2 = document.createElement("option");
                    opt2.value = g.groupid;
                    opt2.textContent = g.group_name;
                    membersSelect.appendChild(opt2);
                }
            } catch (err) {
                console.error("Error loading groups:", err);
                document.getElementById("membersMessage").textContent =
                    "Error loading groups.";
            }
        }

        // ----- Load members for selected group -----
        async function loadGroupMembers(groupId) {
            const body = document.getElementById("membersTableBody");
            const msg = document.getElementById("membersMessage");

            body.textContent = "";
            msg.textContent = "";

            if (!groupId) {
                msg.textContent = "Please select a group.";
                return;
            }

            try {
                const res = await fetch(`/group-members?groupid=${encodeURIComponent(groupId)}`);
                const members = await res.json();

                if (!Array.isArray(members) || members.length === 0) {
                    msg.textContent = "This group has no members yet.";
                    return;
                }

                for (const m of members) {
                    const tr = document.createElement("tr");

                    const tdId = document.createElement("td");
                    tdId.textContent = m.userid;
                    tr.appendChild(tdId);

                    const tdName = document.createElement("td");
                    tdName.textContent = m.name;
                    tr.appendChild(tdName);

                    body.appendChild(tr);
                }
            } catch (err) {
                console.error("Error loading group members:", err);
                msg.textContent = "Error loading group members.";
            }
        }

        // ----- Join group handler -----
        async function joinSelectedGroup() {
            const usernameInput = document.getElementById("joinUsername");
            const joinSelect = document.getElementById("joinGroupSelect");
            const msg = document.getElementById("joinGroupMessage");

            const username = usernameInput.value.trim();
            const groupId = joinSelect.value;
            const groupName = joinSelect.options[joinSelect.selectedIndex]?.text;

            msg.textContent = "";

            if (!username) {
                msg.textContent = "Please enter a username.";
                return;
            }
            if (!groupId) {
                msg.textContent = "Please select a group.";
                return;
            }

            try {
                const res = await fetch("/groups/join", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        username: username,
                        groupname: groupName        // server.js expects "groupname"
                    })
                });

                if (!res.ok) {
                    const errBody = await res.json().catch(() => ({}));
                    console.error("Join group error:", errBody);
                    msg.textContent = errBody.error || "Failed to join group.";
                    return;
                }

                msg.textContent = "Joined group successfully!";

                // After joining, refresh members for this group
                const membersSelect = document.getElementById("membersGroupSelect");
                membersSelect.value = groupId;  // select same group in members dropdown
                await loadGroupMembers(groupId);
            } catch (err) {
                console.error("Join group error:", err);
                msg.textContent = "Failed to join group.";
            }
        }

        // ----- Hook up events on page load -----
        document.addEventListener("DOMContentLoaded", () => {
            // Populate both dropdowns
            loadAllGroups();

            // When group in "View Group Members" changes
            document.getElementById("membersGroupSelect")
                .addEventListener("change", (e) => {
                    loadGroupMembers(e.target.value);
                });

            // When "Join Group" button clicked
            document.getElementById("joinGroupButton")
                .addEventListener("click", joinSelectedGroup);
        });
    </script>
</body>
</html>
