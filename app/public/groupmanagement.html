<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Group Management</title>
    <link rel="stylesheet" type="text/css" href="css/navbar.css">
</head>
<body>
<nav class="navbar">
    <ul class="navbar-menu">
        <li><a href="index.html" class="navbar-item">Search Games</a></li>
        <li><a href="simplesearch.html" class="navbar-item">Search Users/Groups</a></li>
        <li><a href="usermanagement.html" class="navbar-item">Manage Users</a></li>
        <li><a href="groupmanagement.html" class="navbar-item">Manage Groups</a></li>
    </ul>
</nav>

<h1>Group Information</h1>

<!-- ======================== JOIN A GROUP ======================== -->
<h2>Join a Group</h2>

<label for="joinUsername">Username:</label>
<input id="joinUsername" type="text" placeholder="Enter your username">

<label for="availableGroups">Available Groups:</label>
<select id="availableGroups">
    <option value="">Enter a username first</option>
</select>

<br>
<button id="joinGroupBtn">Join Group</button>
<div id="joinGroupMessage" class="message"></div>

<hr>

<h2>Leave a Group</h2>

<label for="leaveUsername">Username:</label>
<input id="leaveUsername" type="text" placeholder="Enter your username">

<label for="userGroups">Your Groups:</label>
<select id="userGroups">
    <option value="">Enter a username first</option>
</select>

<br>
<button id="leaveGroupBtn">Leave Group</button>
<div id="leaveGroupMessage" class="message"></div>

<hr>

<!-- ======================== VIEW GROUP MEMBERS ======================== -->
<h2>View Group Members</h2>

<label for="membersGroupSelect">Group:</label>
<select id="membersGroupSelect">
    <option value="">-- Select a Group --</option>
</select>

<button id="loadMembersBtn">Show Members</button>

<table>
    <thead>
    <tr><th>User ID</th><th>Name</th></tr>
    </thead>
    <tbody id="membersTable"></tbody>
</table>

<hr>

<!-- ======================== GROUP CRUD (like Manage Users) ======================== -->

<p>
    <strong>Current Selected Group:</strong>
    <span id="currentGroupText">None</span>
</p>

<!-- CREATE GROUP -->
<h2>Create a new group</h2>
<p>This will insert a new group into the database.</p>

<label for="newGroupName">Group name:</label>
<input id="newGroupName" type="text">
<br>

<label for="newGroupAgeLimit">Age limit (optional):</label>
<input id="newGroupAgeLimit" type="number" min="0">
<br>

<label for="newGroupBudget">Budget (optional):</label>
<input id="newGroupBudget" type="number" min="0">
<br>

<button id="createGroupButton">Create group</button>
<div id="createGroupMessage" class="message"></div>

<hr>

<!-- SELECT EXISTING GROUP -->
<h2>Select existing group</h2>
<p>Enter an existing group ID or name. This group will be used for the actions below.</p>

<label for="selectedGroupId">Group ID:</label>
<input id="selectedGroupId" type="number" min="1">

<label for="selectedGroupName">or Name:</label>
<input id="selectedGroupName" type="text">
<br>

<button id="loadGroupButton">Load group info</button>
<div id="selectedGroupInfo" class="message"></div>

<hr>

<!-- UPDATE GROUP NAME -->
<h2>Update selected group's name</h2>
<p>Uses the selected group.</p>

<label for="updateGroupName">New name:</label>
<input id="updateGroupName" type="text">
<br>

<button id="updateGroupNameButton">Update group name</button>
<div id="updateGroupNameMessage" class="message"></div>

<hr>

<!-- DELETE GROUP -->
<h2>Delete selected group</h2>
<p>Deletes the selected group from the database.</p>

<button id="deleteGroupButton">Delete group</button>
<div id="deleteGroupMessage" class="message"></div>

<script>
    // ---------- helpers ----------
    async function fetchJson(url, options = {}) {
        const res = await fetch(url, options);
        if (!res.ok) {
            const text = await res.text();
            throw new Error(text || ('HTTP ' + res.status));
        }
        return res.json();
    }

    let currentGroupId = null;

    // ---------- JOIN GROUP ----------
    async function loadAvailableGroupsForUser() {
        const username = document.getElementById("joinUsername").value.trim();
        const select = document.getElementById("availableGroups");
        select.innerHTML = "";

        if (!username) {
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "Enter a username first";
            select.appendChild(opt);
            return;
        }

        try {
            const groups = await fetchJson("/groups/not-in?username=" + encodeURIComponent(username));
            if (groups.length === 0) {
                const opt = document.createElement("option");
                opt.value = "";
                opt.textContent = "No groups available";
                select.appendChild(opt);
                return;
            }
            for (const g of groups) {
                const opt = document.createElement("option");
                opt.value = g.group_name;   // server /groups/join looks up by name
                opt.textContent = g.group_name;
                select.appendChild(opt);
            }
        } catch (err) {
            console.error(err);
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "Error loading groups";
            select.appendChild(opt);
        }
    }

    async function joinSelectedGroup() {
        const username = document.getElementById("joinUsername").value.trim();
        const select   = document.getElementById("availableGroups");
        const groupname = select.value;
        const msg = document.getElementById("joinGroupMessage");
        msg.textContent = "";

        if (!username || !groupname) {
            msg.textContent = "Please enter a username and select a group.";
            return;
        }

        try {
            await fetchJson("/groups/join", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, groupname })
            });
            msg.textContent = "Joined group successfully.";
            // refresh members list if that group is currently selected
            const membersSelect = document.getElementById("membersGroupSelect");
            if (membersSelect.value) {
                loadGroupMembers();
            }
            // refresh available groups for this user (since one was just joined)
            loadAvailableGroupsForUser();
        } catch (err) {
            console.error(err);
            msg.textContent = "Failed to join group.";
        }
    }

    // Leave Group
    async function loadGroupsUserIsIn() {
        const username = document.getElementById("leaveUsername").value.trim();
        const select = document.getElementById("userGroups");
        select.innerHTML = "";

        if (!username) {
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "Enter a username first";
            select.appendChild(opt);
            return;
        }

        try {
            const groups = await fetchJson("/groups/of-user?username=" + encodeURIComponent(username));

            if (groups.length === 0) {
                const opt = document.createElement("option");
                opt.value = "";
                opt.textContent = "User is not in any groups";
                select.appendChild(opt);
                return;
            }

            const seen = new Set();
            for (const g of groups) {
                if (seen.has(g.groupid)) continue;
                seen.add(g.groupid);

                const opt = document.createElement("option");
                opt.value = g.groupid;
                opt.textContent = g.group_name;
                select.appendChild(opt);
            }
        } catch (err) {
            console.error(err);
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "Error loading groups";
            select.appendChild(opt);
        }
    }

    async function leaveSelectedGroup() {
        const username = document.getElementById("leaveUsername").value.trim();
        const select   = document.getElementById("userGroups");
        const groupid  = select.value;
        const msg      = document.getElementById("leaveGroupMessage");
        msg.textContent = "";

        if (!username || !groupid) {
            msg.textContent = "Please enter a username and select a group.";
            return;
        }

        try {
            await fetchJson("/groups/leave", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, groupid: Number(groupid) })
            });

            msg.textContent = "You have left the group.";

            loadGroupsUserIsIn();

            loadAvailableGroupsForUser();

            const membersSelect = document.getElementById("membersGroupSelect");
            if (membersSelect.value === String(groupid)) {
                loadGroupMembers();
            }
        } catch (err) {
            console.error(err);
            msg.textContent = "Failed to leave group.";
        }
    }

    // ---------- VIEW GROUP MEMBERS ----------
    async function loadAllGroupsIntoDropdowns() {
        try {
            const groups = await fetchJson("/groups");

            // members dropdown
            const membersSelect = document.getElementById("membersGroupSelect");
            membersSelect.innerHTML = '<option value="">-- Select a Group --</option>';
            for (const g of groups) {
                const opt = document.createElement("option");
                opt.value = g.groupid;
                opt.textContent = g.group_name;
                membersSelect.appendChild(opt);
            }

        } catch (err) {
            console.error("Error loading groups for dropdowns:", err);
        }
    }

    async function loadGroupMembers() {
        const select = document.getElementById("membersGroupSelect");
        const groupid = select.value;
        const tbody = document.getElementById("membersTable");
        tbody.textContent = "";

        if (!groupid) return;

        try {
            const members = await fetchJson("/group-members?groupid=" + encodeURIComponent(groupid));
            for (const m of members) {
                const tr = document.createElement("tr");
                const td1 = document.createElement("td");
                td1.textContent = m.userid;
                const td2 = document.createElement("td");
                td2.textContent = m.name;
                tr.appendChild(td1);
                tr.appendChild(td2);
                tbody.appendChild(tr);
            }
        } catch (err) {
            console.error("Error loading members:", err);
        }
    }

    // ---------- GROUP CRUD ----------
    function setCurrentGroup(group) {
        if (group) {
            currentGroupId = group.groupid;
            document.getElementById("currentGroupText").textContent =
                `id=${group.groupid}, name=${group.group_name}, age_limit=${group.age_limit}, budget=${group.budget}`;
        } else {
            currentGroupId = null;
            document.getElementById("currentGroupText").textContent = "None";
        }
    }

    async function createGroup() {
        const name     = document.getElementById("newGroupName").value.trim();
        const ageLimit = document.getElementById("newGroupAgeLimit").value;
        const budget   = document.getElementById("newGroupBudget").value;
        const msg      = document.getElementById("createGroupMessage");
        msg.textContent = "";

        if (!name) {
            msg.textContent = "Group name is required.";
            return;
        }

        try {
            const group = await fetchJson("/groups/create", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    groupName: name,
                    ageLimit: ageLimit !== "" ? Number(ageLimit) : null,
                    budget: budget !== "" ? Number(budget) : null
                })
            });
            msg.textContent = `Created group with id=${group.groupid}.`;
            document.getElementById("newGroupName").value = "";
            document.getElementById("newGroupAgeLimit").value = "";
            document.getElementById("newGroupBudget").value = "";
            setCurrentGroup(group);
            await loadAllGroupsIntoDropdowns();
        } catch (err) {
            console.error("Create group error:", err);
            msg.textContent = "Error creating group.";
        }
    }

    async function loadExistingGroup() {
        const idInput   = document.getElementById("selectedGroupId").value;
        const nameInput = document.getElementById("selectedGroupName").value.trim();
        const info      = document.getElementById("selectedGroupInfo");
        info.textContent = "";

        if (!idInput && !nameInput) {
            info.textContent = "Enter a group id or name.";
            return;
        }

        const params = new URLSearchParams();
        if (idInput)   params.append("groupid", idInput);
        if (nameInput) params.append("groupname", nameInput);

        try {
            const group = await fetchJson("/groups/find?" + params.toString());
            if (!group) {
                info.textContent = "Group not found.";
                setCurrentGroup(null);
                return;
            }
            info.textContent =
                `Selected: id=${group.groupid}, name=${group.group_name}, age_limit=${group.age_limit}, budget=${group.budget}`;
            setCurrentGroup(group);
        } catch (err) {
            console.error("Load group error:", err);
            info.textContent = "Error loading group.";
        }
    }

    async function updateGroupName() {
        const newName = document.getElementById("updateGroupName").value.trim();
        const msg     = document.getElementById("updateGroupNameMessage");
        msg.textContent = "";

        if (!currentGroupId) {
            msg.textContent = "Select a group first.";
            return;
        }
        if (!newName) {
            msg.textContent = "Enter a new name.";
            return;
        }

        try {
            const group = await fetchJson("/groups/update-name", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ groupid: currentGroupId, groupName: newName })
            });
            msg.textContent = "Group name updated.";
            setCurrentGroup(group);
            document.getElementById("updateGroupName").value = "";
            await loadAllGroupsIntoDropdowns();
        } catch (err) {
            console.error("Update group name error:", err);
            msg.textContent = "Error updating group name.";
        }
    }

    async function deleteGroup() {
        const msg = document.getElementById("deleteGroupMessage");
        msg.textContent = "";

        if (!currentGroupId) {
            msg.textContent = "Select a group first.";
            return;
        }

        if (!window.confirm("Are you sure you want to delete this group?")) {
            return;
        }

        try {
            await fetchJson("/groups/delete", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ groupid: currentGroupId })
            });
            msg.textContent = "Group deleted.";
            setCurrentGroup(null);
            document.getElementById("selectedGroupId").value = "";
            document.getElementById("selectedGroupName").value = "";
            await loadAllGroupsIntoDropdowns();
            document.getElementById("membersTable").textContent = "";
        } catch (err) {
            console.error("Delete group error:", err);
            msg.textContent = "Error deleting group.";
        }
    }

    // ---------- wire up events ----------
    document.getElementById("joinUsername")
        .addEventListener("change", loadAvailableGroupsForUser);
    document.getElementById("joinUsername")
        .addEventListener("blur", loadAvailableGroupsForUser);

    document.getElementById("joinGroupBtn")
        .addEventListener("click", joinSelectedGroup);

    document.getElementById("leaveUsername")
        .addEventListener("change", loadGroupsUserIsIn);
    document.getElementById("leaveUsername")
        .addEventListener("blur", loadGroupsUserIsIn);

    document.getElementById("leaveGroupBtn")
        .addEventListener("click", leaveSelectedGroup);

    document.getElementById("loadMembersBtn")
        .addEventListener("click", loadGroupMembers);

    document.getElementById("createGroupButton")
        .addEventListener("click", createGroup);

    document.getElementById("loadGroupButton")
        .addEventListener("click", loadExistingGroup);

    document.getElementById("updateGroupNameButton")
        .addEventListener("click", updateGroupName);

    document.getElementById("deleteGroupButton")
        .addEventListener("click", deleteGroup);

    // initial load
    loadAllGroupsIntoDropdowns();
</script>

</body>
</html>
